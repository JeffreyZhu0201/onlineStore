<view class="container">
  <!-- 加载状态 -->
  <van-loading wx:if="{{ loading }}" custom-class="page-loading" />

  <block wx:else>
    <!-- 商品图片轮播 -->
    <swiper class="goods-swiper" indicator-dots circular>
      <swiper-item wx:for="{{ goods.images }}" wx:key="*this">
        <van-image
          width="100%"
          height="100%"
          src="{{ item }}"
          bind:tap="onPreviewImage"
          data-index="{{ index }}"
          lazy-load
        />
      </swiper-item>
    </swiper>

    <!-- 商品信息 -->
    <view class="goods-info">
      <view class="price-section">
        <view class="current-price">¥{{ goods.price }}</view>
        <view class="original-price">¥{{ goods.originalPrice }}</view>
        <view class="sales">销量 {{ goods.sales }}</view>
      </view>
      <view class="title">{{ goods.title }}</view>
      <view class="tags">
        <van-tag plain type="danger">正品保证</van-tag>
        <van-tag plain type="warning">七天退换</van-tag>
        <van-tag plain type="primary">极速发货</van-tag>
      </view>
    </view>

    <!-- 商品规格 -->
    <van-cell-group title="商品规格" border="{{ false }}">
      <van-cell
        wx:for="{{ goods.specifications }}"
        wx:key="name"
        title="{{ item.name }}"
        value="{{ item.value }}"
        border="{{ false }}"
      />
    </van-cell-group>

    <!-- 商品详情 -->
    <view class="detail-section">
      <view class="section-title">商品详情</view>
      <view class="show-detail-btn" bind:tap="onShowDetail" wx:if="{{ !showDetail }}">
        <text>查看详情</text>
        <van-icon name="arrow-down" />
      </view>
      
      <block wx:if="{{ showDetail }}">
        <view class="description">{{ goods.description }}</view>
        
        <!-- 详情图片 -->
        <view class="detail-images">
          <van-image
            wx:for="{{ detailImages }}"
            wx:key="*this"
            width="100%"
            height="500rpx"
            src="{{ item }}"
            lazy-load
            custom-class="detail-image"
          />
        </view>

        <!-- 加载更多状态 -->
        <view class="loading-status">
          <block wx:if="{{ detailLoading }}">
            <van-loading size="24px">加载中...</van-loading>
          </block>
          <block wx:elif="{{ !hasMore }}">
            <view class="no-more">没有更多了</view>
          </block>
        </view>
      </block>
    </view>

    <!-- 规格选择弹出层 -->
    <van-popup
      show="{{ showSkuPopup }}"
      position="bottom"
      round
      custom-style="max-height: 80%"
      bind:close="closeSkuPopup"
    >
      <view class="sku-popup">
        <!-- 商品信息 -->
        <view class="sku-header">
          <van-image
            width="100"
            height="100"
            src="{{ goods.images[0] }}"
            radius="4"
          />
          <view class="sku-info">
            <view class="sku-price">¥{{ goods.price }}</view>
            <view class="sku-selected">
              已选：{{ selectedSpecs.color || '请选择' }} {{ selectedSpecs.size || '请选择' }}
            </view>
          </view>
        </view>

        <!-- 颜色选择 -->
        <view class="sku-row">
          <view class="sku-row-title">颜色</view>
          <van-radio-group
            value="{{ selectedSpecs.color }}"
            bind:change="onSpecChange"
            direction="horizontal"
            data-type="color"
          >
            <van-radio
              wx:for="{{ specifications.color }}"
              wx:key="*this"
              name="{{ item }}"
              custom-class="sku-radio"
            >
              {{ item }}
            </van-radio>
          </van-radio-group>
        </view>

        <!-- 尺码选择 -->
        <view class="sku-row">
          <view class="sku-row-title">尺码</view>
          <van-radio-group
            value="{{ selectedSpecs.size }}"
            bind:change="onSpecChange"
            direction="horizontal"
            data-type="size"
          >
            <van-radio
              wx:for="{{ specifications.size }}"
              wx:key="*this"
              name="{{ item }}"
              custom-class="sku-radio"
            >
              {{ item }}
            </van-radio>
          </van-radio-group>
        </view>

        <!-- 数量选择 -->
        <view class="sku-row">
          <view class="sku-row-title">数量</view>
          <van-stepper
            value="{{ selectedNum }}"
            bind:change="onNumChange"
            min="1"
            max="99"
          />
        </view>

        <!-- 确认按钮 -->
        <view class="sku-actions">
          <van-button
            type="danger"
            block
            round
            bind:tap="onConfirmSku"
          >
            确定
          </van-button>
        </view>
      </view>
    </van-popup>

    <!-- 底部操作栏 -->
    <van-goods-action>
      <van-goods-action-icon
        icon="chat-o"
        text="客服"
        bind:tap="onContact"
        open-type="contact"
      />
      <van-goods-action-icon
        icon="{{ goods.isCollected ? 'star' : 'star-o' }}"
        text="收藏"
        bind:tap="onCollect"
      />
      <van-goods-action-icon
        icon="share-o"
        text="分享"
        bind:tap="onShare"
        open-type="share"
      />
      <van-goods-action-button
        text="加入购物车"
        type="warning"
        bind:tap="openSkuPopup"
        data-type="cart"
      />
      <van-goods-action-button
        text="立即购买"
        bind:tap="openSkuPopup"
        data-type="buy"
      />
    </van-goods-action>
  </block>
</view> 